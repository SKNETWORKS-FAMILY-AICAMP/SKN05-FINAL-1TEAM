from typing import Annotated, TypedDict, List
import retriever
import ensemble_retriever
import bm25_retriever

# ğŸ”¹ ì§ˆë¬¸ ê´€ë ¨ State
class QuestionState(TypedDict):
    question: Annotated[str, "Original question from user"]
    transform_question: Annotated[List[str], "Transformed queries generated by LLM"]  # List íƒ€ì… ìœ ì§€

# ğŸ”¹ ê²€ìƒ‰ ë° ì»¨í…ìŠ¤íŠ¸ ê´€ë ¨ State
class ContextRetrievalState(TypedDict):
    ensemble_context: Annotated[str, "Ensemble Retrieved Context"]
    multi_context: Annotated[str, "Multi Query Retrieved Context"]
    merge_context: Annotated[str, "Merged Context"]
    filtered_context: Annotated[str, "Filtered Context"]
    rerank_context: Annotated[str, "Reranked Context"]  # í‘œì¤€í™”ëœ key ì´ë¦„ ìœ ì§€

# ğŸ”¹ ë‹µë³€ ë° ë©”ì‹œì§€ ê´€ë ¨ State
class AnswerState(TypedDict):
    answer: Annotated[str, "Final Answer"]
    message: Annotated[List[dict], "Message history"]  # List[dict]ë¡œ ë³€ê²½

# ğŸ”¹ ì „ì²´ Graph State (ê° State í¬í•¨)
class GraphState(TypedDict):
    question_state: QuestionState
    context_retrieval_state: ContextRetrievalState
    answer_state: AnswerState


# ğŸ”¹ **ê¸°ë³¸ Retrieverë¥¼ ì´ìš©í•˜ì—¬ ë¬¸ì„œ ê²€ìƒ‰**
def retrieve_document(state: GraphState) -> GraphState:
    """
    ê¸°ë³¸ Retrieverë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
    """
    question = state["question_state"]["question"]  # ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
    documents = retriever.invoke(question)  # ê¸°ë³¸ retriever í˜¸ì¶œ
    print(f"ğŸ” Retrieved documents: {documents}")

    # ì—…ë°ì´íŠ¸ëœ State ë°˜í™˜
    state["context_retrieval_state"]["multi_context"] = documents  # multi_queryì—ì„œ ê°€ì ¸ì˜¨ ì»¨í…ìŠ¤íŠ¸
    return state


# ğŸ”¹ **Ensemble Retrieverë¥¼ ì´ìš©í•œ ê²€ìƒ‰**
def ensemble_document(state: GraphState) -> GraphState:
    """
    Ensemble Retrieverë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
    """
    question = state["question_state"]["question"]  # ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
    documents = ensemble_retriever.invoke(question)  # Ensemble retriever í˜¸ì¶œ
    print(f"ğŸ” Ensemble Retrieved documents: {documents}")

    # ì—…ë°ì´íŠ¸ëœ State ë°˜í™˜
    state["context_retrieval_state"]["ensemble_context"] = documents  # Ensemble retrieval ì ìš© ê²°ê³¼ ì €ì¥
    return state


# ğŸ”¹ **BM25 Retrieverë¥¼ ì´ìš©í•œ ê²€ìƒ‰ (ì˜µì…˜)**
def bm25_document(state: GraphState) -> GraphState:
    """
    BM25 ê¸°ë°˜ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    """
    question = state["question_state"]["question"]  # ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
    if bm25_retriever:
        documents = bm25_retriever.invoke(question)  # BM25 retriever í˜¸ì¶œ
        print(f"ğŸ” BM25 Retrieved documents: {documents}")

        # ì—…ë°ì´íŠ¸ëœ State ë°˜í™˜
        state["context_retrieval_state"]["filtered_context"] = documents  # BM25 ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ì €ì¥
    else:
        print("âš ï¸ BM25 Retrieverê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ê²€ìƒ‰ë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤.")

    return state
